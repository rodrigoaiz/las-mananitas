---
import { getCollection } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import VoteCTA from "../../components/VoteCTA.astro";
import FloatingVote from "../../components/FloatingVote.astro";
import Breadcrumbs from "../../components/Breadcrumbs.astro";
import RelatedArticles from "../../components/RelatedArticles";
import ShareButtons from "../../components/ShareButtons";

export async function getStaticPaths() {
  const articulos = await getCollection("articulos");
  return articulos.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();

const breadcrumbItems = [
  { label: "Inicio", href: "/" },
  { label: "Â¡Queremos Pastel!", href: "/queremos-pastel/" },
  { label: entry.data.title, href: "#" },
];

// Get all articles for related articles
const allArticles = await getCollection("articulos");
const relatedArticlesData = allArticles.map((a) => ({
  title: a.data.title,
  description: a.data.description,
  emoji: a.data.emoji,
  slug: a.slug,
}));

// Calculate reading time (aproximadamente 200 palabras por minuto)
const wordCount = entry.body.split(/\s+/).length;
const readingTime = Math.ceil(wordCount / 200);

const currentUrl = new URL(Astro.url.pathname, Astro.site).toString();
---

<Layout
  title={entry.data.seoTitle || `${entry.data.title} | Historia de Las MaÃ±anitas - Â¡Queremos Pastel!`}
  description={entry.data.description}
  image={entry.data.image}
  article={{
    publishedTime: entry.data.pubDate.toISOString(),
    modifiedTime: entry.data.dateModified?.toISOString(),
    authorName: entry.data.author,
  }}
>
  <main class="py-20 px-4 sm:px-6 lg:px-8">
    <article class="max-w-3xl mx-auto">
      <!-- Breadcrumbs -->
      <Breadcrumbs items={breadcrumbItems} />

      <!-- Back button -->
      <a
        href="/queremos-pastel"
        class="inline-flex items-center gap-2 text-slate-400 hover:text-pink-600 font-bold uppercase tracking-widest text-sm mb-12 transition-colors group"
      >
        <svg
          class="w-4 h-4 transform group-hover:-translate-x-2 transition-transform"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="3"
            d="M11 17l-5-5m0 0l5-5m-5 5h12"></path>
        </svg>
        Volver a Â¡Queremos Pastel!
      </a>

      <div class="text-center mb-16">
        <div class="text-8xl mb-8 animate-float">
          {entry.data.emoji}
        </div>
        <h1
          class="text-5xl sm:text-6xl font-black text-slate-900 mb-6 tracking-tight leading-tight"
        >
          {entry.data.title}
        </h1>
        <p class="text-xl text-slate-500 font-medium italic">
          {entry.data.description}
        </p>

        <!-- Reading time -->
        <div class="mt-4 flex items-center gap-2 text-sm text-slate-400 font-medium">
          <svg
            class="w-4 h-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <span>{readingTime} min de lectura</span>
        </div>

        <!-- Subtle top CTA -->
        <div class="mt-8 flex justify-center">
          <a
            href="/#survey"
            class="text-sm font-black uppercase tracking-widest text-pink-600 bg-pink-50 px-6 py-2 rounded-full hover:bg-pink-100 transition-colors"
          >
            ðŸ”¥ Ãšnete al gran debate aquÃ­
          </a>
        </div>
      </div>

      <div
        class="prose prose-slate prose-xl max-w-none
        prose-headings:font-black prose-headings:text-slate-900 prose-headings:tracking-tight
        prose-p:text-slate-600 prose-p:leading-relaxed
        prose-strong:text-slate-900 prose-strong:font-bold
        prose-a:text-pink-600 prose-a:no-underline hover:prose-a:underline
        prose-li:text-slate-600
        bg-white/40 backdrop-blur-md border border-white/40 rounded-[3rem] p-10 sm:p-16 shadow-2xl shadow-pink-200/10"
      >
        <Content />
      </div>

      <!-- Share buttons -->
      <div class="mt-12 flex justify-center">
        <ShareButtons url={currentUrl} title={entry.data.title} client:load />
      </div>

      <VoteCTA />

      <!-- Related articles -->
      <RelatedArticles
        currentSlug={entry.slug}
        articles={relatedArticlesData}
        client:load
      />

      <div class="mt-20 text-center border-t border-slate-200 pt-12">
        <p class="text-slate-400 font-medium">
          Escrito por <span class="text-slate-900 font-bold"
            >{entry.data.author}</span
          > el {
            entry.data.pubDate.toLocaleDateString("es-MX", {
              year: "numeric",
              month: "long",
              day: "numeric",
            })
          }
        </p>
      </div>
    </article>
  </main>
  <FloatingVote />
</Layout>

<style is:global>
  @reference "../../styles/global.css";

  /* Custom styles for markdown content if needed */
  .prose h2 {
    @apply text-3xl mt-12 mb-6;
  }
  .prose h3 {
    @apply text-2xl mt-8 mb-4;
  }
  .prose p {
    @apply mb-6;
  }
  .prose ul {
    @apply list-disc list-inside mb-6 space-y-2;
  }
</style>
